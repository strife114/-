# LNMP+Wordpress+Redis

## 实验环境

| IP              | 节点规划             | 性能  |
| --------------- | -------------------- | ----- |
| 192.168.223.5   | LNMP+Wordpress+redis | 1核2G |
| 192.168.223.6   | LNMP+Wordpress       | 1核2G |
| 192.168.223.101 | Nginx代理            | 2核4G |

## 部署（请在192.168.223.5、192.168.223.6的节点ip做lnmp部署）

### 安装nginx

1. 设置yum源

   ```sh
   vim /etc/yum.repos.d/nginx.repo
   
   [nginx]
   name = nginx repo
   baseurl = https://nginx.org/packages/mainline/centos/7/$basearch/
   gpgcheck = 0
   enabled = 1
   ```

2. 安装

   ```sh
   yum install -y nginx
   ```

3. 修改default.conf文件

   ```sh
    vi /etc/nginx/conf.d/default.conf
    
    server {
    listen 80;
    root /usr/share/nginx/html;
    server_name localhost;
    #charset koi8-r;
    #access_log /var/log/nginx/log/host.access.log main;
    #
    location / {
    index index.php index.html index.htm;
    }
    #error_page 404 /404.html;
    #redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    root /usr/share/nginx/html;
    }
    #pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ .php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    }
   }
   ```

4. 设置启动和自启

   ```sh
   systemctl start nginx
   systemctl enable nginx
   ```

5. 浏览器访问虚拟机ip

### 安装Mariadb（此处192.168.223.6节点可不安装数据库服务）

1. 查看是否安装

   ```sh
   rpm -qa |grep -i mariadb
   
   
   # 如果有就删除
   yum remove -y mariadb-libs
   ```

2. 设置yum源

   ```sh
   vi /etc/yum.repos.d/MariaDB.repo
   
   [mariadb]
   name = MariaDB
   baseurl = https://mirrors.cloud.tencent.com/mariadb/yum/10.4/centos7-amd64
   gpgkey=https://mirrors.cloud.tencent.com/mariadb/yum/RPM-GPG-KEY-MariaDB
   gpgcheck=1
   ```

3. 下载

   ```sh
   yum -y install  MariaDB-client MariaDB-server
   ```

4. 启动并自启

   ```sh
   systemctl start mariadb
   systemctl enable mariadb
   ```

5. 测试

   ```sh
   mysql
   ```

### 安装PHP

1. 更新yum中php软件源

   ```sh
   rpm -Uvh https://mirrors.cloud.tencent.com/epel/epel-release-latest-7.noarch.rpm
   
   rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
   ```

2. 下载

   ```sh
   yum -y install mod_php72w.x86_64 php72w-cli.x86_64 php72w-common.x86_64 php72w-mysqlnd php72w-fpm.x86_64
   ```

3. 启动并自启

   ```sh
   systemctl start php-fpm
   systemctl enable php-fpm
   ```

4. 创建文件

   ```sh
   vim /usr/share/nginx/html/index.php
   
   <?php
   phpinfo();
   ?>
   ```

5. 重启

   ```sh
   systemctl restart nginx
   ```

6. 测试

   ```sh
   本机ip/index.php
   ```



## 搭建Wordpress（请在192.168.223.5、192.168.223.6节点做wordpress部署）

1. 进入192.168.223.5的数据库

   ```sh
   # 进入数据库
   mysql
   
   # 创建数据库
   create database wordpress;
   # 赋权
   grant all privileges on *.* to "wordpress"@"localhost" identified by '000000';
   # 赋权192.168.223.6的用户权限
   grant all privileges on *.* to "wordpress"@"localhost" identified by '000000';
   # 更新权限
   flush privileges;
   
   # 重启
   systemctl restart mariadb
   ```

2. 删除nginx的html下的所有文件

   ```sh
   rm -rf /usr/share/nginx/html/*
   ```

3. 上传解压wordpress安装包

4. 复制系统文件到网页解析目录下

   ```sh
   # 强制复制wordpress下的所有东西到/usr/share/nginx/html/下
   cp -rf wordpress/*   /usr/share/nginx/html/
   
   cd /usr/share/nginx/html/
   ```

5. 部署wordpress

   ```sh
   # 192.168.223.5
   # 备份
   cp wp-config-sample.php wp-config.php
   vim wp-config.php
   
    21 // ** MySQL
    22 /** WordPress
    23 define('DB_NAME', 'wordpress');
    24
    25 /** MySQL数据库⽤户名 */
    26 define('DB_USER', 'wordpress');
    27
    28 /** MySQL数据库密码 */
    29 define('DB_PASSWORD', '000000');
    30
    31 /** MySQL主机 */
    32 define('DB_HOST', 'localhost');
    33
    34 /** 创建数据表时默认的⽂字编码 */
    35 define('DB_CHARSET', 'utf8');
    
    
    
    
   # 192.168.223.6
    21 // ** MySQL
    22 /** WordPress
    23 define('DB_NAME', 'wordpress');
    24
    25 /** MySQL数据库⽤户名 */
    26 define('DB_USER', 'wordpress');
    27
    28 /** MySQL数据库密码 */
    29 define('DB_PASSWORD', '000000');
    30
    31 /** MySQL主机 */
    32 define('DB_HOST', '192.168.223.5');
    33
    34 /** 创建数据表时默认的⽂字编码 */
    35 define('DB_CHARSET', 'utf8');
    
   ```

6. 赋权

   ```sh
   chmod -R 777 /usr/share/nginx/html/
   ```

7. 查看端口

   ```sh
   netstat -ntlp 
   ```

8. 打开浏览器输入虚拟机ip



## 部署负载均衡(192.168.223.101)

1. 设置yum源

   ```sh
   vim /etc/yum.repos.d/nginx.repo
   
   [nginx]
   name = nginx repo
   baseurl = https://nginx.org/packages/mainline/centos/7/$basearch/
   gpgcheck = 0
   enabled = 1
   ```

2. 安装

   ```sh
   yum install -y nginx
   ```

3. 启动并设置自启

   ```
   systemctl start nginx
   systemctl enable nginx
   ```

4. 修改配置文件

   ```sh
   [root@localhost ~]# cat /etc/nginx/nginx.conf 
   user  nginx;
   worker_processes  auto;
   
   error_log  /var/log/nginx/error.log notice;
   pid        /var/run/nginx.pid;
   
   
   events {
       worker_connections  1024;
   }
   
   
   http {
       include       /etc/nginx/mime.types;
       default_type  application/octet-stream;
   
       log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for"';
   
       access_log  /var/log/nginx/access.log  main;
   
       sendfile        on;
       #tcp_nopush     on;
   
       keepalive_timeout  65;
   
       #gzip  on;
       upstream  apacheserver{
       server  192.168.223.5;
       server  192.168.223.6;
   }
   server{
       listen  80;
       server_name   www.123.com;
       location  / {
       proxy_pass  http://apacheserver;
       root   html;
       index  index.html  index.htm;
   }
   }
       include /etc/nginx/conf.d/*.conf;
   }
   
   ```

5. 重启服务

   ```
   systemctl restart nginx
   ```

6. 测试

   ```
   vim /usr/share/nginx/html/index.html
   1111
   
   vim /usr/share/nginx/html/index.html
   222
   
   
   # 稍后会在下方有图形展示
   ```

   

## 扩展redis(192.168.223.5)

1. 安装redis

   ```sh
   # yum  -y install  https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm
   # 修改yum源
   # vim /etc/yum.repos.d/remi.repo
   修改如下：
   [remi]
   name=Remi's RPM repository for Enterprise Linux 7 - $basearch
   #baseurl=http://rpms.remirepo.net/enterprise/7/remi/$basearch/
   #mirrorlist=https://rpms.remirepo.net/enterprise/7/remi/httpsmirror
   mirrorlist=http://cdn.remirepo.net/enterprise/7/remi/mirror
   enabled=1        这里原本默认是0的修改为1开启
   gpgcheck=1
   gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi
   
   # 安装redis
   [root@localhost ~]# yum  -y install redis-5*
   ```

2. 安装php-redis连接驱动

   ```sh
   # yum -y install php-redis
   
   
   
   # 注意
   1. 会出现依赖包冲突问题
   
   # 解决方法
   1. 安装所有php72w前缀
      yum install -y php72w*
   ```

3. 修改配置文件（192.168.223.5和192.168.223.6的wp-config.php都要修改）

   ```sh
   vim /usr/share/nginx/html/wp-config.php
   # 在最后一行加上三行
   define("FS_METHOD", "direct");
   define("FS_CHMOD_DIR", 0777);
   define("FS_CHMOD_FILE", 0777);
   
   
   # 注意
   1. 这里主要是redis插件ftp服务使用
   ```

4. 添加插件

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis1.png)

5. 指定redis服务器ip（192.168.223.5）

   ```sh
   vim /usr/share/nginx/html/wp-content/plugins/redis-cache/includes/object-cache.php
   # 搜索6379即可找到
    protected function build_parameters() {
           $parameters = [
               'scheme' => 'tcp',
               'host' => '127.0.0.1',
               'port' => 6379,
               'database' => 0,
               'timeout' => 1,
               'read_timeout' => 1,
               'retry_interval' => null,
               'persistent' => false,
           ];
           
           
   # 注意
   1. 因为这里本人配置到本机redis，所以不必修改
   ```

6. 启动服务

   ```sh
   systemctl start redis
   systemctl enable redis
   ```

7. 查看缓存信息

   ```sh
   [root@localhost html]# redis-cli
   127.0.0.1:6379> KEYS *
    1) "wp:site-transient:update_plugins"
    2) "wp:options:nonce_key"
    3) "wp:options:can_compress_scripts"
    4) "wp:options:nonce_salt"
    5) "wp:post_tag_relationships:1"
    6) "wp:site-transient:poptags_40cd750bba9870f18aada2478b24840a"
    7) "wp:terms:get_terms-7b517923119523f1d371fe25128d21f1-0.81377000 1683191641"
    8) "wp:terms:get_terms-d2f0d42213c61ca358a12deb1ac5bd5d-0.81377000 1683191641"
    9) "wp:options:auth_salt"
   10) "wp:comment:get_comment_child_ids-1-884eb2c92eb464aa20f51bacdb7ddae8-0.82581200 1683191641"
   11) "wp:transient:is_multi_author"
   12) "wp:redis-cache:metrics"
   13) "wp:terms:get_terms-4a07b3c34e4f5e405db2481c939e29b5-0.81377000 1683191641"
   14) "wp:terms:get_terms-994fbdb7c0aa097dcd83686e00184577-0.81377000 1683191641"
   15) "wp:users:1"
   16) "wp:user_meta:1"
   17) "wp:comment:get_comments-9503889e74633f729bf0ed7217c233a4-0.82581200 1683191641"
   18) "wp:terms:1"
   19) "wp:comment:last_changed"
   20) "wp:comment:get_comments-95c334f059a78c67a1c0073fd7e467bc-0.82581200 1683191641"
   21) "wp:post_format_relationships:1"
   22) "wp:site-transient:update_themes"
   23) "wp:site-transient:available_translations"
   24) "wp:options:notoptions"
   25) "wp:useremail:admin@admin.com"
   26) "wp:post_meta:1"
   27) "wp:site-transient:update_core"
   28) "wp:category_relationships:1"
   29) "wp:comment:1"
   30) "wp:comment:get_comments-884eb2c92eb464aa20f51bacdb7ddae8-0.82581200 1683191641"
   31) "wp:default:is_blog_installed"
   32) "wp:posts:last_changed"
   33) "wp:userslugs:strife"
   34) "wp:transient:twentyseventeen_categories"
   35) "wp:options:logged_in_key"
   36) "wp:options:logged_in_salt"
   37) "wp:transient:plugin_slugs"
   38) "wp:terms:get_terms-55e00a2479938f82355c3418aae351a9-0.81377000 1683191641"
   39) "wp:posts:wp_get_archives-53058f6b83972cfc3253e30ef06fcaa9-0.83946400 1683191641"
   40) "wp:options:theme_mods_twentyseventeen"
   41) "wp:options:alloptions"
   42) "wp:options:auth_key"
   43) "wp:options:recently_edited"
   44) "wp:term_meta:1"
   45) "wp:userlogins:strife"
   46) "wp:posts:1"
   47) "wp:terms:last_changed"
   ```

   

## 验证图片

1. 负载均衡

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/fuzai1.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/fuzai2.png)

2. redis

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis2.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis3.png)