



# 基本环境搭建

## 修改主机名(2)

```
hostnamectl set-hostname controller
bash

hostnamectl set-hostname compute
bash



```



## yum源搭建（2）

1. 挂载光盘

   ```
   【挂载CentOS-7-x86_64-DVD-1804.iso】
   [root@controller ~]# mount -o loop CentOS-7-x86_64-DVD-1804.iso  /mnt/
   [root@controller ~]# mkdir /opt/centos /opt/iaas
   [root@controller ~]# cp -rvf /mnt/* /opt/centos/
   [root@controller ~]# umount  /mnt/
   
   【挂载XianDian-IaaS-v2.4.iso】
   [root@controller ~]# mount -o loop XianDian-IaaS-v2.4.iso  /mnt/
   [root@controller ~]# cp -rvf /mnt/* /opt/iaas
   [root@controller ~]# umount  /mnt/
   
   
   
   
   
   # 查看yum源
   yum repolist
   
   
   
   ```
   
2. 创建repo文件

   ```
   删除所有的yum配置文件
   rm -rf /etc/yum.repo.d/*
   # 创建centos.repo文件
   # 注意隐藏字符，容易导致报错
   [centos]
   name=centos
   baseurl=file:///opt/centos
   gpgcheck=0
   enabled=1
   [iaas]
   name=iaas
   baseurl=file:///opt/iaas/iaas-repo
   gpgcheck=0
   enabled=1
   
   ```

3. 执行yum源更新命令

   ```
   yum clean all
   yum makecache 或 yum list  #本质都是生成缓存
   ```
   
4. 安装vim、net-tools

   ```
   yum install -y vim
   
   yum install -y net-tools
   netstat -ntlp  //查看是否安装成功
   ```
   
## 配置安全（selinux和防火墙、2）

  ```
   vi /etc/selinux/config
   SELINUX=disabled
   
   systemctl stop firewalld.service
   systemctl disable firewalld.service
   yum remove -y NetworkManager firewalld
   
   
   # 安装iptables，清空防火墙规则
   yum install -y iptables-services
   systemctl enable iptables
   systemctl restart iptables
   iptables -F
   iptables -X
   iptables -Z
   service iptables save
  
  
  
  
  ```

## 设置密钥传输

```
# vi /etc/hosts
192.168.223.120 controller
192.168.223.121 compute

# ssh-keygen
回车
# ssh-copy-id compute


# 概率出现检测不到公钥
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
```



## 编辑环境变量（2）

1. 下载iaas-xiandian

   ```
   yum install -y iaas-xiandian
   ```

2. 编辑执行文件

   ```
   ##--------------------system Config--------------------##
   ##Controller Server Manager IP. example:x.x.x.x
   # controller节点IP
   HOST_IP=192.168.223.120
   
   ##Controller HOST Password. example:000000 
   HOST_PASS=000000
   
   ##Controller Server hostname. example:controller
   # controller节点名称
   HOST_NAME=controller
   
   ##Compute Node Manager IP. example:x.x.x.x
   # compute节点ip
   HOST_IP_NODE=192.168.223.121
   
   ##Compute HOST Password. example:000000 
   HOST_PASS_NODE=000000
   
   ##Compute Node hostname. example:compute
   # compute节点ip
   HOST_NAME_NODE=compute
   
   ##--------------------Chrony Config-------------------##
   ##Controller network segment IP.  example:x.x.0.0/16(x.x.x.0/24)
   # 设置网段
   network_segment_IP=192.168.223.0/24
   
   ##--------------------Rabbit Config ------------------##
   ##user for rabbit. example:openstack
   RABBIT_USER=openstack
   
   ##Password for rabbit user .example:000000
   RABBIT_PASS=000000
   
   ##--------------------MySQL Config---------------------##
   ##Password for MySQL root user . exmaple:000000
   DB_PASS=000000
   
   ##--------------------Keystone Config------------------##
   ##Password for Keystore admin user. exmaple:000000
   DOMAIN_NAME=demo
   ADMIN_PASS=000000
   DEMO_PASS=000000
   
   ##Password for Mysql keystore user. exmaple:000000
   KEYSTONE_DBPASS=000000
   
   ##--------------------Glance Config--------------------##
   ##Password for Mysql glance user. exmaple:000000
   GLANCE_DBPASS=000000
   
   ##Password for Keystore glance user. exmaple:000000
   GLANCE_PASS=000000
   
   ##--------------------Nova Config----------------------##
   ##Password for Mysql nova user. exmaple:000000
   NOVA_DBPASS=000000
   
   ##Password for Keystore nova user. exmaple:000000
   NOVA_PASS=000000
   
   ##--------------------Neturon Config-------------------##
   ##Password for Mysql neutron user. exmaple:000000
   NEUTRON_DBPASS=000000
   
   ##Password for Keystore neutron user. exmaple:000000
   NEUTRON_PASS=000000
   
   ##metadata secret for neutron. exmaple:000000
   METADATA_SECRET=000000
   
   ##Tunnel Network Interface. example:x.x.x.x
   # 本机ip
   INTERFACE_IP=192.16.223.121
   
   ##External Network Interface. example:eth1
   INTERFACE_NAME=ens34
   
   ##External Network The Physical Adapter. example:provider
   Physical_NAME=provider
   
   ##First Vlan ID in VLAN RANGE for VLAN Network. exmaple:101
   minvlan=1
   
   ##Last Vlan ID in VLAN RANGE for VLAN Network. example:200
   # 根据大赛要求的vlan分配vlan范围
   maxvlan=1000
   
   ##--------------------Cinder Config--------------------##
   ##Password for Mysql cinder user. exmaple:000000
   CINDER_DBPASS=000000
   
   ##Password for Keystore cinder user. exmaple:000000
   CINDER_PASS=000000
   
   ##Cinder Block Disk. example:md126p3
   # 空白分区
   BLOCK_DISK=vdb1
   
   ##--------------------Swift Config---------------------##
   ##Password for Keystore swift user. exmaple:000000
   SWIFT_PASS=000000
   
   ##The NODE Object Disk for Swift. example:md126p4.
   # 空白分区
   OBJECT_DISK=vdb2
   
   ##The NODE IP for Swift Storage Network. example:x.x.x.x.
   # compute节点ip
   STORAGE_LOCAL_NET_IP=192.168.223.120
   
   ##--------------------Heat Config----------------------##
   ##Password for Mysql heat user. exmaple:000000
   HEAT_DBPASS=000000
   
   ##Password for Keystore heat user. exmaple:000000
   HEAT_PASS=000000
   
   ##--------------------Zun Config-----------------------##
   ##Password for Mysql Zun user. exmaple:000000
   ZUN_DBPASS=000000
   
   ##Password for Keystore Zun user. exmaple:000000
   ZUN_PASS=000000
   
   ##Password for Mysql Kuryr user. exmaple:000000
   KURYR_DBPASS=000000
   
   ##Password for Keystore Kuryr user. exmaple:000000
   KURYR_PASS=000000
   
   ##--------------------Ceilometer Config----------------##
   ##Password for Gnocchi ceilometer user. exmaple:000000
   CEILOMETER_DBPASS=000000
   
   ##Password for Keystore ceilometer user. exmaple:000000
   CEILOMETER_PASS=000000
   
   ##--------------------AODH Config----------------##
   ##Password for Mysql AODH user. exmaple:000000
   AODH_DBPASS=000000
   
   ##Password for Keystore AODH user. exmaple:000000
   AODH_PASS=000000
   
   ##--------------------Barbican Config----------------##
   ##Password for Mysql Barbican user. exmaple:000000
   BARBICAN_DBPASS=000000
   
   ##Password for Keystore Barbican user. exmaple:000000
   BARBICAN_PASS=000000
   
   
   
   注意：主控结点不需要分区，计算节点需要分区并设置空白分区
   ```







## 安装Openstack(2)

### 简介

1. OpenStack既是一个社区，也是一个项目和一个开源软件，它提供了一个部署云的操作平台或工具集（IaaS）。其宗旨在于：帮助组织运行为虚拟计算或存储服务的云，为公有云、私有云提供可扩展的、灵活的云计算
2. OpenStack主要包含以下几个组件，各个组件的功能如下，其中Nova，Keyston，Neutron，Glance，DashBoard为必须装的组件，其余可以选择性安装，图为OpenStack生态系统





```
# 基础配置命令(安装Openstack、chrony、配置域名)己编写成shell脚本，通过脚本一键安装
# 注意重启
iaas-pre-host.sh
```





## 安装数据库(controller)

1. 安装

   ```
   # 在controller节点上使用iaas-install-mysql.sh 脚本安装Mariadb、Memcached、RabbitMQ消息队列等服务
   iaas-install-mysql.sh
   
   ```

2. 配置数据库

   ```
   # 创建test库
   create database test;
   use test;
   
   # 在库test中创建表company（表结构如(id int not null primary key,name varchar(50),addr varchar(255))
   create table company( id int(10) not null primary key, name varchar(50), addr varchar(255));
   
   # 在表company中插入一条数据(1,"alibaba","china")
   insert into company(id,name,addr)values(1,"alibaaba","china");
   
   flush privileges;
   ```

3. 配置RabbitMQ服务

   ```
   # 创建用户chinaskill，密码为chinapd
   rabbitmqctl add_user chinaskill chinapd
   # 赋予administrator权限
   rabbitmqctl set_user_tags chinaskill administrator
   ```



## 安装Keystone认证服务(controller)

### 简介

1. 提供所有组件的认证

### 安装

1. 安装

   ```
   # 使用脚本iaas-install-keystone.sh安装Keystone服务
   iaas-install-keystone.sh
   ```



## 安装Glance镜像服务（controller）

### 简介

1. 提供镜像服务

### 安装

1. 安装

   ```
   # 使用iaas-install-glance.sh脚本安装glance 服务
   iaas-install-glance.sh
   ```

   

## 安装Nova计算服务(2)

### 简介

1. 计算管理服务，支撑虚拟机运行

### 安装

1. 安装

   ```
   # 执行脚本部署nova组件的控制服务
   iaas-install-nova-controller.sh
   
   # 执行完上面的脚本后，在compute节点执行脚本部署nova组件的计算服务，这样就将compute节点的cpu、内存及磁盘资源添加到OpenStack云平台的资源池中了。
   iaas-install-nova-compute.sh
   ```



## 安装Neutron网络服务(2)

### 简介

1. 提供网络支持

### 安装

1. 安装

   ```
   # 分别iaas-install-neutron-controller.sh脚本、iaas-install-neutron-compute.sh脚本分别安装 Neutron 服务，网络默认是vlan模式
   iaas-install-neutron-controller.sh
   iaas-install-neutron-compute.sh
   ```



## 安装Dashboard网页管理界面服务(controller)

### 简介

1. 提供web管理界面服务

### 安装

1. 安装

   ```
   # 使用iaas-install-dashboard.sh脚本安装dashboad服务。
   iaas-install-dashboard.sh
   
   
   # 到此步可截至，根据比赛要求而定
   ```



## 安装Swift对象存储服务(2)

### 简介

1. 提供对象存储

### 安装

1. 安装

   ```
   # 分别使用iaas-install-swift-controller.sh和iaas-install-swift-compute.sh脚本安装Swift服务并创建test容器
   iaas-install-swift-controller.sh
   iaas-install-swift-compute.sh
   ```



## 安装Cinder块存储服务(2)

### 简介

1. 提供扩展硬盘给nova

### 安装

1. 安装

   ```
   # 分别使用iaas-install-cinder-controller.sh、iaas-install-cinder-compute.sh脚本安装Cinder服务
   iaas-install-cinder-controller.sh
   iaas-install-cinder-compute.sh
   ```

2. 创建名字(controller)

   ```
   # 使用cinder命令创建一个名字叫blockvolume，大小为2G的云硬盘
   source /etc/keystone/admin-openrc.sh
   cinder type-create blockvolume
   cinder create 2 --name blockvolume --volume-type blockvolume
   cinder list
   ```



## 安装DNS服务(controller)

### 简介

1. Designate 是一个开源 DNS 即服务实施，是用于运行云的 OpenStack 服务生态系统的一部分。
   Designate 是 OpenStack 的多租户 DNSaaS 服务。它提供了一个带有集成 Keystone 身份验证的 REST API。它可以配置为根据 Nova 和 Neutron 操作自动生成记录。Designate 支持多种 DNS 服务器，包括 Bind9 和 PowerDNS 4

### 安装

1. 执行脚本

   ```
   iaas-install-designate.sh
   ```

   

## 安装Heat编配服务(controller)

### 简介

1. heat支持云平台资源自动部署，集群服务

### 安装

1. 安装

   ```
   # 使用iaas-install-heat.sh脚本安装Heat服务
   iaas-install-heat.sh
   
   ```
   



## 安装cloudkitty计费服务(controller)

### 简介

1. 当前Cloudkitty的整体架构，包括计费服务的对象获取（Tenant Fetcher）、计费数据源的收集（Collector）、计费引擎（Rating）的实现，计费费用数据的存储（Storage）

### 安装

1. 安装

   ```
   iaas-install-cloudkitty.sh
   ```



## 安装Blazar资源预订服务(controller)

### 简介

1. Blazar 是 OpenStack 的资源预留项目，通过 Blazar 用户可以让 OpenStack 在 “租约（leased）” 期内预留出特定的资源以供使用。

   **预留的资源类型**：

   - **虚拟预留资源**：Nova Instances、Cinder Volumes、Neutron Networks
   - **物理预留资源**：Compute Host（full hosts with specific characteristics of RAM, CPU, etc）

   **应用场景**:

   - 为尖峰负载准备资源
   - 将租约作为计量结算单元
   - 优化能源消耗
   - 申请专用资源

### 安装

1. 安装

   ```
   iaas-install-blazar.sh
   ```



## 安装Ceilometer监控服务(2)

### 简介

1. [Celiometer](https://docs.openstack.org/ceilometer/pike/admin/index.html)是OpenStack的计量与监控组件，官方的正式名称为OpenStack Telemetry，用来获取和保存计量与监控的各种测量值，并根据测量值进行报警。同时这些保存下来的测量值也可以被第三方系统获取，用来做更进一步的分析、处理或展示。

     计量与监控是公有云运营的一个重要环节，计量是为了获取系统中用户对各种资源的使用情况，监控是为了确保资源处于健康的状态

### 安装

1. 安装

   ```
   iaas-install-ceilometer-controller.sh
   iaas-install-ceilometer-compute.sh
   ```



## 安装Aodh告警服务(controller)

### 简介

1. [Openstack](https://so.csdn.net/so/search?q=Openstack&spm=1001.2101.3001.7020)告警服务Aodh负责当收集的数据度量或事件超过所设定的阈值时，会出发报警。从Liberty 版本后从Ceilometer 中拆分出来，独立为单独的项目，Aodh告警可以出发多种形式的动作，目前已经实现的动作有HTTP回调，日志记录和 通过 Zaqar的API发送通知消息

### 安装

1. 安装

   ```
   iaas-install-aodh.sh
   ```

   

# 环境运维

## 镜像管理(controller)

### 查看镜像

```
 glance image-list


# 查看镜像详细信息
glance image-show  ID
```



### 上传镜像

```
# glance image-create 
参数：
 --disk-format：镜像格式
 --container-format： 镜像在其他项目中可见性
 --progress： 显示上传镜像的进度
 --file：选择本地镜像文件
 --name：上传后镜像的名称



source /etc/keystone/admin-openrc.sh
 
 glance image-create --name cirros --disk-format qcow2 --container-format bare < cirros-0.3.4-x86_64-disk.img 
 
 glance image-create --name "CentOS7.5" --disk-format qcow2 --container-format bare --progress < CentOS_7.5_x86_64_XD.qcow2
```



### 修改镜像

```
glance image-update
选项：
 --min-disk：镜像启动最小硬盘大小
 --name：镜像名称
 --disk-format：镜像格式
 --min-ram：镜像启动最小内存大小
 --container-format：镜像在项目中可见性

# 改变镜像启动硬盘最低要求值（min-disk）1G
glance image-update --min-disk=1 32a2513c-e5ba-438b-a5ee-63c35c03b284
```



### 删除镜像

```
glance image-delete ID


glance image-delete 32a2513c-e5ba-438b-a5ee-63c35c03b284
```



## 网络管理(controller)

### 创建网络（命令）

```
# controller

source /etc/keystone/admin-openrc.sh
openstack network create net
openstack subnet create --network net --subnet-range 10.0.0.0/24 --gateway 10.0.0.1 subnet

openstack subnet create --network net --subnet-range 网络地址 --gateway 网关地址 子网名
```

### 创建网络（图形化）

```
# 创建外网
名称：net-wai
项目：admin
供应商：VLAN
物理网络：provider
段ID:222
四个全选
子网名：in-wai
网络地址：192.168.222.0/24
网关：192.168.222.1
启动DHCP
地址池：192.168.222.3,192.168.222.200



# 创建内网
名称：net-nei
项目：admin
供应商：Flat
物理网络：provider
四个全选
子网名：in-nei
网络地址：192.168.120.0/24
网关：192.168.120.1
关闭DHCP
```



## 云主机管理(controller)

### 创建云主机类型（图像）

```
管理员--》云主机类型--》创建云主机类型

名称：controller
vcpu：2
内存：2048
根磁盘：30
临时磁盘：0
swap：0
因子：默认

注意：创建的类型必须满足镜像最小需求性能
```

### 创建云主机类型（命令）

```
# 创建名为“m1.flavor”、 ID 为 1234、内存为1024MB、硬盘为20GB、vcpu数量为 1的云主机类型。
openstack flavor create --id 1 --ram 1024 --disk 10 --vcpu 1 m1.flavor

openstack flavor create --id id名 --ram 内存 --disk 硬盘容量 --vcpu cpu核数 类型名
```

### 查看云主机类型

```
openstack flavor list 

# 查看centos的详细信息
openstack flavor show centos
```

### 创建云主机

```
# 使用cirros镜像，flavor为2核vCPU、1G内存、10G硬盘，使用network-vlan网络。云主机名为“cirros-test
openstack server create --image cirros-0.4.5 --flavor 1 --netwrok network-clan cirros-test
```

### 查看云主机

```
 openstack server list

# 查看具体信息 
openstack server show cirros-test
```

### 操作云主机

```
openstack server start/stop/reboot cirros-test
```

### 调整云主机

```
# 使用命令调整云主机“cirros-test”类型为centos1，使用–wait参数，在命令执行后，调整云主机需要一定时间，添加–wait参数后会在确认时回馈“complete
openstack server resize --flavor centos1 --wait cirros-test	
```



## 访问安全组

```
# 查看访问安全组
openstack security group list

# 查看安全组default中的安全规则
openstack security group rule list default

# 查看规则的详细信息
openstack security group rule show ID


# 创建安全组
openstack security group create test

# 删除安全组
openstack security group delete test

# 添加安全策略
# 在default中添加策略，从入口方向放行所有ICMP规则
openstack security group rule create --protocol icmp --ingress default
# 在“defualt”安全组中添加一条策略，从入口方向放行所有TCP规则
openstack security group rule create --protocol tcp --ingress  default
# 在“defualt”安全组中添加一条策略，从入口方向放行所有UDP规则
 openstack security group rule create --protocol udp --ingress  default
```



## 块存储管理

```
# 查看服务状态
openstack volume service list

# 查看块存储信息
openstack volume list
# 查看volume1的详细信息
openstack volume show volume1

# 创建块存储
openstack volume create 
# 通过命令创建块存储，大小为2G，名称为“volume1”
openstack volume create --size 2 volume1

# 挂载云硬盘
openstack server add volume
# 使用命令将创建的“volume”块存储添加至云主机“cirros-test”上
openstack server add volume cirros-test volume1

# 调整块存储
openstack volume set
# 通过命令将 “volume1” 卷大小从2G扩容至3G
openstack volume set --size 3 volume1
```



## 对象存储管理

```
# 查看服务状态
swift stat

# 查看容器
openstack container list

# 查看容器详细信息
openstack container show  swift-test1

# 创建容器
openstack container create swift-test1

# 删除容器
openstack container delete
# 删除swift-test1容器（有对象则无法删除）
openstack container delete swift-test1
# 将容器内部对象一起删除
openstack container delete --recursive swift-test1
# 查看对象
openstack object list
# 查看容器swift-test1中所有对象的信息
openstack object list swift-test1

# 查看容器中对象的详细信息
openstack object show swift-test1 test/anaconda-ks.cfg

# 创建对象
# 在使用命令创建对象前，需要将上传后的目录结构在本地创建。在本地创建名为“test”的目录“/root/test”，将/root/anaconda-ks.cfg文件复制至“/root/test”目录中
openstack object create
# 使用命令创建“test/anaconda-ks.cfg
openstack object create swift-test test/anaconda-ks.cfg

# 下载对象
openstack object save
# 使用命令将“swift-test1”容器中“test/anaconda-ks.cfg”对象下载至本地/opt/目录下(会下载到当前目录)
openstack object save swift-test1 test/anaconda-ks.cfg 

# 删除对象
openstack object delete
使用删除对象命令将“swift-test1”容器内“test/anaconda-ks.cfg”删除
openstack object delete swift-test1 test/anaconda-ks.cfg


# 分片存储

# 上传镜像至容器test并进行分片(10m)
swift upload test -S 10000000 cirros-0.3.4-x86_64-disk.img

# 查看cirros镜像的存储路径
swift stat test cirros-0.3.4-x86_64-disk.img

# 查看存储路径中数据片
siwft list test_segments
```



## 配置文件

```
# vim /etc/nova/nova.conf
修改#virt_type=kvm
#virt_type=qcmu

systemctl restart openstack-nova-compute或systemctl restart openstack-nova-computels
```



# 参数调优

## Nova关键参数调优

```
# vim /etc/nova/nova.conf
# 预留前2个物理CPU，把后面的所有CPU分配给虚拟机使用（假设vcpu为16个）
vcpu_pin_set=2-15

# 设置cpu超售比例为4倍
cpu_allocation_ratio=4.0
# 设置内存超售比例为1.5倍
ram_allocation_ratio=1.5

# 预留2048mb内存，这部分内存不能被虚拟机使用
reserved_host_memory_mb=2048
# 预留1024mb硬盘，这部分不能被使用
reserved_host_disk_mb=1024

# 设置nova服务心跳检查时间为120秒
service_down_time=120
# 设置超时时间
rpc_response_timeout=300 RPC
最大返回数据长度限制
osapi_max_limit = 5000
```

## Keyston关键参数调优

## Glance关键参数调优

```
# 处理请求的子进程数量，如果为0则只有一个主进程
workers = 2 glance-api
# 最大返回数据长度限制
api_limit_max = 1000
# 一个响应中的最大返回项数
limit_param_default=1000
```





# Heat编排部署

