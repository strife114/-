



# 基本环境搭建

## 修改主机名(2)

```
hostnamectl set-hostname controller
bash

hostnamectl set-hostname compute
bash


vim /etc/hosts
192.168.223.120 controller
192.168.223.121 compute

```



## yum源搭建（2）

1. 挂载光盘

   ```
   方法1：
   mkdir /mnt/centos /mnt/iaas
   
   # 挂载光盘
   mount /dev/sr0 /mnt/centos
   # 挂载本地
   mv chinaskills_cloud_iaas.iso /iaas.iso
   mount /iaas.iso /mnt/iaas
   
   
   方法2：
   
   【挂载CentOS-7-x86_64-DVD-1804.iso】
   [root@controller ~]# mount -o loop CentOS-7-x86_64-DVD-1804.iso  /mnt/
   [root@controller ~]# mkdir /opt/centos /opt/iaas
   [root@controller ~]# cp -rvf /mnt/* /opt/centos/
   [root@controller ~]# umount  /mnt/
   
   【挂载XianDian-IaaS-v2.4.iso】
   [root@controller ~]# mount -o loop XianDian-IaaS-v2.4.iso  /mnt/
   [root@controller ~]# cp -rvf /mnt/* /opt/iaas
   [root@controller ~]# umount  /mnt/
   
   
   
   
   
   # 查看yum源
   yum repolist
   
   
   
   
   
   
   
   
   
   
   永久挂载：
   vim /etc/fstab
   
   #
   # /etc/fstab
   # Created by anaconda on Wed Feb 22 08:37:36 2023
   #
   # Accessible filesystems, by reference, are maintained under '/dev/disk'
   # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
   #
   /dev/mapper/centos-root /                       xfs     defaults        0 0
   UUID=91a73c25-da77-4303-a79d-823ee8d5ce07 /boot                   xfs     defaults        0 0
   /dev/mapper/centos-home /home                   xfs     defaults        0 0
   /dev/mapper/centos-swap swap                    swap    defaults        0 0
   
   /dev/sr0  /mnt/centos                 iso9660  defaults 0 0
   /iaas.iso /mnt/iaas                   iso9660 defaults 0 0
   ```

2. 创建repo文件

   ```
   删除所有的yum配置文件
   rm -rf /etc/yum.repo.d/*
   # 创建centos.repo文件
   # 注意隐藏字符，容易导致报错
   [centos]
   name=centos
   baseurl=file:///opt/centos
   gpgcheck=0
   enabled=1
   [iaas]
   name=iaas
   baseurl=file:///opt/iaas/iaas-repo
   gpgcheck=0
   enabled=1
   
   ```

3. 执行yum源更新命令

   ```
   yum clean all
   yum makecache 或 yum list  #本质都是生成缓存
   yum update
   ```

4. 安装vim、net-tools

   ```
   yum install -y vim
   
   yum install -y net-tools
   netstat -ntlp  //查看是否安装成功
   ```
   
## 配置安全（selinux和防火墙、2）

  ```
   vi /etc/selinux/config
   SELINUX=disabled
   
   systemctl stop firewalld.service
   systemctl disable firewalld.service
   yum remove -y NetworkManager firewalld
   # 安装iptables
   # iptables 是 Linux 防火墙系统的重要组成部分，iptables 的主要功能是实现对网络数据包进出设备及转发的控制。当数据包需要进入设备、从设备中流出或者由该设备转发、路由时，都可以使用 iptables 进行控制
   yum install -y iptables-services
   systemctl enable iptables
   systemctl restart iptables
   iptables -F
   iptables -X
   iptables -Z
   service iptables save
  
  
  ```



## 编辑环境变量（2）

1. 下载iaas-xiandian

   ```
   yum install -y iaas-xiandian
   ```

2. 编辑执行文件

   ```
   ##--------------------system Config--------------------##
   ##Controller Server Manager IP. example:x.x.x.x
   # controller节点IP
   HOST_IP=192.168.223.120
   
   ##Controller HOST Password. example:000000 
   HOST_PASS=000000
   
   ##Controller Server hostname. example:controller
   # controller节点名称
   HOST_NAME=controller
   
   ##Compute Node Manager IP. example:x.x.x.x
   # compute节点ip
   HOST_IP_NODE=192.168.223.121
   
   ##Compute HOST Password. example:000000 
   HOST_PASS_NODE=000000
   
   ##Compute Node hostname. example:compute
   # compute节点ip
   HOST_NAME_NODE=compute
   
   ##--------------------Chrony Config-------------------##
   ##Controller network segment IP.  example:x.x.0.0/16(x.x.x.0/24)
   # 设置网段
   network_segment_IP=192.168.223.0/24
   
   ##--------------------Rabbit Config ------------------##
   ##user for rabbit. example:openstack
   RABBIT_USER=openstack
   
   ##Password for rabbit user .example:000000
   RABBIT_PASS=000000
   
   ##--------------------MySQL Config---------------------##
   ##Password for MySQL root user . exmaple:000000
   DB_PASS=000000
   
   ##--------------------Keystone Config------------------##
   ##Password for Keystore admin user. exmaple:000000
   DOMAIN_NAME=demo
   ADMIN_PASS=000000
   DEMO_PASS=000000
   
   ##Password for Mysql keystore user. exmaple:000000
   KEYSTONE_DBPASS=000000
   
   ##--------------------Glance Config--------------------##
   ##Password for Mysql glance user. exmaple:000000
   GLANCE_DBPASS=000000
   
   ##Password for Keystore glance user. exmaple:000000
   GLANCE_PASS=000000
   
   ##--------------------Nova Config----------------------##
   ##Password for Mysql nova user. exmaple:000000
   NOVA_DBPASS=000000
   
   ##Password for Keystore nova user. exmaple:000000
   NOVA_PASS=000000
   
   ##--------------------Neturon Config-------------------##
   ##Password for Mysql neutron user. exmaple:000000
   NEUTRON_DBPASS=000000
   
   ##Password for Keystore neutron user. exmaple:000000
   NEUTRON_PASS=000000
   
   ##metadata secret for neutron. exmaple:000000
   METADATA_SECRET=000000
   
   ##Tunnel Network Interface. example:x.x.x.x
   # 本机ip
   INTERFACE_IP=192.16.223.121
   
   ##External Network Interface. example:eth1
   INTERFACE_NAME=ens34
   
   ##External Network The Physical Adapter. example:provider
   Physical_NAME=provider
   
   ##First Vlan ID in VLAN RANGE for VLAN Network. exmaple:101
   minvlan=101
   
   ##Last Vlan ID in VLAN RANGE for VLAN Network. example:200
   maxvlan=200
   
   ##--------------------Cinder Config--------------------##
   ##Password for Mysql cinder user. exmaple:000000
   CINDER_DBPASS=000000
   
   ##Password for Keystore cinder user. exmaple:000000
   CINDER_PASS=000000
   
   ##Cinder Block Disk. example:md126p3
   # 空白分区
   BLOCK_DISK=sdb1
   
   ##--------------------Swift Config---------------------##
   ##Password for Keystore swift user. exmaple:000000
   SWIFT_PASS=000000
   
   ##The NODE Object Disk for Swift. example:md126p4.
   # 空白分区
   OBJECT_DISK=sdb4
   
   ##The NODE IP for Swift Storage Network. example:x.x.x.x.
   # controller节点ip
   STORAGE_LOCAL_NET_IP=192.168.223.120
   
   ##--------------------Heat Config----------------------##
   ##Password for Mysql heat user. exmaple:000000
   HEAT_DBPASS=000000
   
   ##Password for Keystore heat user. exmaple:000000
   HEAT_PASS=000000
   
   ##--------------------Zun Config-----------------------##
   ##Password for Mysql Zun user. exmaple:000000
   ZUN_DBPASS=000000
   
   ##Password for Keystore Zun user. exmaple:000000
   ZUN_PASS=000000
   
   ##Password for Mysql Kuryr user. exmaple:000000
   KURYR_DBPASS=000000
   
   ##Password for Keystore Kuryr user. exmaple:000000
   KURYR_PASS=000000
   
   ##--------------------Ceilometer Config----------------##
   ##Password for Gnocchi ceilometer user. exmaple:000000
   CEILOMETER_DBPASS=000000
   
   ##Password for Keystore ceilometer user. exmaple:000000
   CEILOMETER_PASS=000000
   
   ##--------------------AODH Config----------------##
   ##Password for Mysql AODH user. exmaple:000000
   AODH_DBPASS=000000
   
   ##Password for Keystore AODH user. exmaple:000000
   AODH_PASS=000000
   
   ##--------------------Barbican Config----------------##
   ##Password for Mysql Barbican user. exmaple:000000
   BARBICAN_DBPASS=000000
   
   ##Password for Keystore Barbican user. exmaple:000000
   BARBICAN_PASS=000000
   
   ```







## 安装Openstack(2)

### 简介

1. OpenStack既是一个社区，也是一个项目和一个开源软件，它提供了一个部署云的操作平台或工具集（IaaS）。其宗旨在于：帮助组织运行为虚拟计算或存储服务的云，为公有云、私有云提供可扩展的、灵活的云计算
2. OpenStack主要包含以下几个组件，各个组件的功能如下，其中Nova，Keyston，Neutron，Glance，DashBoard为必须装的组件，其余可以选择性安装，图为OpenStack生态系统





```
# 基础配置命令(安装Openstack、chrony、配置域名)己编写成shell脚本，通过脚本一键安装
# 注意重启
iaas-pre-host.sh
```





## 安装数据库(controller)

1. 安装

   ```
   # 在controller节点上使用iaas-install-mysql.sh 脚本安装Mariadb、Memcached、RabbitMQ消息队列等服务
   iaas-install-mysql.sh
   
   ```

2. 配置数据库

   ```
   # 创建test库
   create database test;
   use test;
   
   # 在库test中创建表company（表结构如(id int not null primary key,name varchar(50),addr varchar(255))
   create table company( id int(10) not null primary key, name varchar(50), addr varchar(255));
   
   # 在表company中插入一条数据(1,"alibaba","china")
   insert into company(id,name,addr)values(1,"alibaaba","china");
   
   flush privileges;
   ```

3. 配置RabbitMQ服务

   ```
   # 创建用户chinaskill，密码为chinapd
   rabbitmqctl add_user chinaskill chinapd
   # 赋予administrator权限
   rabbitmqctl set_user_tags chinaskill administrator
   ```



## 安装Keystone认证服务(controller)

### 简介

1. 提供所有组件的认证

### 安装

1. 安装

   ```
   # 使用脚本iaas-install-keystone.sh安装Keystone服务
   iaas-install-keystone.sh
   ```



## 安装Glance镜像服务（controller）

### 简介

1. 提供镜像服务

### 安装

1. 安装

   ```
   # 使用iaas-install-glance.sh脚本安装glance 服务
   iaas-install-glance.sh
   ```

   

## 安装Nova计算服务(2)

### 简介

1. 计算管理服务，支撑虚拟机运行

### 安装

1. 安装

   ```
   # 执行脚本部署nova组件的控制服务
   iaas-install-nova-controller.sh
   
   # 执行完上面的脚本后，在compute节点执行脚本部署nova组件的计算服务，这样就将compute节点的cpu、内存及磁盘资源添加到OpenStack云平台的资源池中了。
   iaas-install-nova-compute.sh？
   ```



## 安装Neutron网络服务(2)

### 简介

1. 提供网络支持

### 安装

1. 安装

   ```
   # 分别iaas-install-neutron-controller.sh脚本、iaas-install-neutron-compute.sh脚本分别安装 Neutron 服务，网络默认是vlan模式
   iaas-install-neutron-controller.sh
   iaas-install-neutron-compute.sh
   ```



## 安装Dashboard网页管理界面服务(controller)

### 简介

1. 提供web管理界面服务

### 安装

1. 安装

   ```
   # 使用iaas-install-dashboard.sh脚本安装dashboad服务。
   iaas-install-dashboard.sh
   ```



## 安装Swift对象存储服务(2)

### 简介

1. 提供对象存储

### 安装

1. 安装

   ```
   # 分别使用iaas-install-swift-controller.sh和iaas-install-swift-compute.sh脚本安装Swift服务并创建test容器
   iaas-install-swift-controller.sh
   iaas-install-swift-compute.sh
   ```



## 安装Cinder块存储服务(2)

### 简介

1. 提供扩展硬盘给nova

### 安装

1. 安装

   ```
   # 分别使用iaas-install-cinder-controller.sh、iaas-install-cinder-compute.sh脚本安装Cinder服务
   iaas-install-cinder-controller.sh
   iaas-install-cinder-compute.sh
   ```

2. 创建名字(controller)

   ```
   # 使用cinder命令创建一个名字叫blockvolume，大小为2G的云硬盘
   source /etc/keystone/admin-openrc.sh
   cinder type-create blockvolume
   cinder create 2 --name blockvolume --volume-type blockvolume
   cinder list
   ```



## 安装Heat编配服务(controller)

### 简介

1. heat支持云平台资源自动部署，集群服务

### 安装

1. 安装

   ```
   # 使用iaas-install-heat.sh脚本安装Heat服务
   iaas-install-heat.sh
   
   ```
   
   



# 环境运维

## 镜像管理(controller)

### 上传镜像

```
 source /etc/keystone/admin-openrc.sh
 glance image-create --name cirros --disk-format qcow2 --container-format bare < cirros-0.3.4-x86_64-disk.img 
```



## 网络管理(controller)

### 创建网络（命令）

```
# controller
source /etc/keystone/admin-openrc.sh
openstack network create net
openstack subnet create --network net --subnet-range 10.0.0.0/24 --gateway 10.0.0.1 subnet
```



## 云主机管理(controller)

### 创建云主机

```
登录dashboard页面，在左侧菜单栏中选择“项目”-“计算”-“实例”，点击“创建实例”，输入实例名称cirros，默认可用域为nova，数量为1，点击下一步；选择已共享的cirros镜像，选择不创建新卷，点击下一步；选择
m1.tiny实例类型，点击下一步；选择net为虚拟机的网络；这样点击“创建实例”按钮就可以完成虚拟机创建
```

